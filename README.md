# Flash Arbitrage Bot

加密货币期货多时间框架插针套利交易系统

## 项目概述

Flash Arbitrage Bot 是一个专为币安期货市场设计的高频套利交易系统。系统通过多时间框架分析检测"插针"现象，并采用两阶段入场策略实现双向盈利。

### 核心特性

- **多时间框架分析**: 30s/1m/5m/15m 多时间框架趋势判断
- **智能插针检测**: 基于连续K线、颜色反转、位置确认的综合检测算法
- **两阶段入场策略**: 第一腿顺势入场 + 第二腿回调锁利
- **实时K线追踪**: WebSocket实时价格更新，自动生成和更新K线数据
- **测试网交易**: 支持币安期货测试网完整交易功能
- **数据持久化**: 完整的交易历史记录，支持JSON/CSV导出

---

## 快速开始

### 环境要求

- Python 3.11+
- 币安期货测试网账户

### 安装步骤

```bash
# 克隆项目
git clone <repository-url>
cd Flash_Arbitrage_bot/python

# 安装依赖
pip install -r requirements.txt
```

### 配置

1. **获取测试网 API 密钥**
   - 访问 https://testnet.binancefuture.com/
   - 注册并获取 API Key 和 Secret

2. **设置环境变量**
   ```bash
   # Windows PowerShell
   $env:BINANCE_TESTNET_API_KEY="your_api_key"
   $env:BINANCE_TESTNET_API_SECRET="your_api_secret"
   ```

3. **手动开启双向持仓模式**
   - 登录测试网页端
   - 在持仓模式中开启"双向持仓"

### 运行

```bash
cd python
python testnet_mtf_trading.py
```

---

## 策略说明

### 多时间框架插针检测逻辑

系统使用4个时间框架进行复合验证：

| 时间框架 | 用途 | 检测条件 |
|----------|------|----------|
| 30秒 | 趋势确认 | 连续5根阳线/阴线 |
| 1分钟 | 回调确认 | 当前价格不再延续趋势 |
| 5分钟 | 回调确认 | 当前价格不再延续趋势 |
| 15分钟 | 位置确认 | 在近16根高点/低点附近 + 回落0.15% |

### 信号类型

**上涨插针 (UP_PIN)** - 做空机会
- 检测: 30秒K线连续5根阳线 → 1m/5m/15m颜色反转 → 处于15分钟高点
- 策略: 高位做空 → 回调做多锁利 → 先平空 → 后平多

**下跌插针 (DOWN_PIN)** - 做多机会
- 检测: 30秒K线连续5根阴线 → 1m/5m/15m颜色反转 → 处于15分钟低点
- 策略: 低位做多 → 反弹做空锁利 → 先平多 → 后平空

### 两阶段入场策略

```
┌─────────────────────────────────────────────────────────┐
│                    上涨插针示例                         │
├─────────────────────────────────────────────────────────┤
│  价格                                              │
│    ↑ 3.68  ┌─────────────────┐                       │
│    │       │  第一腿: 做空    │                       │
│    │       └─────────────────┘                       │
│    │                                                  │
│    ├ 3.66  ┌─────────────────┐                       │
│    │       │  第二腿: 做多    │ ← 锁定空单利润         │
│    │       │  (回调时触发)    │                       │
│    │       └─────────────────┘                       │
│    │                                                  │
│    ↓ 3.64  ┌─────────────────┐                       │
│           │  先平空 (盈利)    │                       │
│           └─────────────────┘                       │
│    │                                                  │
│    └──────  ┌─────────────────┐                       │
│             │  后平多 (低买高卖) │                       │
│             └─────────────────┘                       │
└─────────────────────────────────────────────────────────┘
```

---

## 配置参数

### 交易参数 (`config/testnet_config.py`)

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `POSITION_USDT` | 15.0 | 单笔仓位大小(USDT) |
| `LEVERAGE` | 20 | 杠杆倍数 |
| `FEE_RATE` | 0.0004 | 手续费率(0.04%) |

### 对冲策略参数 (`SimpleHedgeConfig`)

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `HEDGE_ENTRY_PERCENT` | 0.006 | 对冲入场阈值(0.6%) |
| `FIRST_LEG_TARGET_PERCENT` | 0.008 | 第一腿目标盈利(0.8%) |
| `SECOND_LEG_WAIT_SECONDS` | 300 | 第二腿等待时间(300秒) |

### 信号检测参数 (`MTFPinDetectorConfig`)

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `TREND_CONSECUTIVE_BARS` | 5 | 趋势确认所需连续K线数 |
| `POSITION_BARS_COUNT` | 16 | 位置判断的K线数量 |
| `POSITION_THRESHOLD` | 0.0015 | 位置判断阈值(0.15%) |
| `MIN_PULLBACK` | 0.0015 | 最小回撤幅度(0.15%) |

### 风控参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `MAX_DAILY_TRADES` | 100 | 每日最大交易次数 |
| `MAX_DAILY_LOSS_USDT` | 100.0 | 每日最大亏损(USDT) |
| `MAX_CONSECUTIVE_LOSSES` | 100 | 最大连续亏损次数 |

---

## 项目结构

```
Flash_Arbitrage_bot/
├── python/
│   ├── testnet_mtf_trading.py      # 主运行器 (多时间框架策略)
│   ├── config/
│   │   └── testnet_config.py        # 测试网配置
│   ├── src/
│   │   ├── exchange/
│   │   │   └── binance_futures.py   # 币安期货API客户端
│   │   ├── trading/
│   │   │   ├── simple_hedge.py      # 对冲执行器
│   │   │   ├── trade_logger.py      # 交易日志记录器
│   │   │   └── ...
│   │   └── analysis/
│   │       ├── kline_tracker.py     # K线追踪器
│   │       ├── mtf_detector.py      # 多时间框架插针检测器
│   │       └── ...
│   ├── logs/                         # 运行日志
│   └── testnet_trades/               # 交易记录
└── README.md
```

---

## 核心模块说明

### 1. KlineTracker (`src/analysis/kline_tracker.py`)

多时间框架K线数据追踪器，支持：
- 实时价格更新自动生成K线
- 历史K线数据加载
- 连续K线统计
- 价格位置判断

### 2. MTFPinDetector (`src/analysis/mtf_detector.py`)

多时间框架插针检测器：
- 趋势确认 (30秒连续K线)
- 回调确认 (1m/5m颜色反转)
- 位置确认 (15m高低点)
- 信号置信度计算

### 3. SimpleHedgeExecutor (`src/trading/simple_hedge.py`)

对冲交易执行器：
- 两阶段入场执行
- 自动平仓逻辑
- 持仓状态管理
- 盈亏统计

### 4. BinanceFuturesClient (`src/exchange/binance_futures.py`)

币安期货API客户端：
- 账户信息查询
- 订单下单/撤单
- 杠杆调整
- K线数据获取
- 完整的错误处理

---

## 数据记录

交易记录保存在 `testnet_trades/` 目录：
- `hedge_trades_YYYYMMDD_HHMMSS.json` - JSON格式
- `hedge_trades_YYYYMMDD_HHMMSS.csv` - CSV格式

### 记录内容

```json
{
  "export_time": "2026-01-14T18:00:00",
  "total_trades": 10,
  "trades": [
    {
      "symbol": "BTCUSDT",
      "direction": "UP",
      "entry_price": 95000.0,
      "first_side": "SHORT",
      "first_pnl": 0.5000,
      "second_pnl": 0.2000,
      "total_pnl": 0.7000,
      ...
    }
  ]
}
```

---

## 运行日志示例

```
[18:00:00] ============================================================
[18:00:00] Flash Arbitrage Bot - 多时间框架策略（测试网）
[18:00:00] ============================================================
[18:00:00] 测试交易所连接...
[18:00:00] 连接成功 | 可用余额: 10585.38 USDT
[18:00:00] ============================================================
[18:00:00] 多时间框架策略已启动
[18:00:00] 监控: BTCUSDT, ETHUSDT, SOLUSDT, BNBUSDT, TRUMPUSDT...
[18:00:00] 配置: 15.0 USDT × 20x
[18:00:00] 参数: 对冲0.6% | 目标0.8% | 等待300s
[18:00:00] ============================================================
[18:00:00] 等待信号...
[18:00:05] 加载历史K线数据...
[18:00:05] 历史数据加载完成 (成功: 111, 跳过30s: 0)
[18:00:05] WebSocket已连接
```

---

## 风险提示

- 本项目仅供学习和研究使用
- 加密货币交易具有高风险
- 测试网环境与主网可能存在差异
- 请在充分测试后再考虑实盘

---

## 许可证

MIT License
